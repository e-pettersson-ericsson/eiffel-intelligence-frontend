sudo: required

language: java

services:
  - docker

jdk:
  - oraclejdk8


# Using default 'test' stage for our tests, and only running deploy stage
# (after merge) on master branch
stages:
  - name: site_documentation
    if: $TRAVIS_BRANCH = test-release-notes AND $TRAVIS_PULL_REQUEST = false
  - name: release
    if: $TRAVIS_BRANCH = test-release-notes AND $TRAVIS_PULL_REQUEST = false

# To prevent Travis from also running build on pushed tags
# (and have endless loop of builds for every git push --tags)
branches:
  except:
    - /^[0-9]+\.[0-9]+\.[0-9]+$/

# Prepare site documentation
before_deploy:
  - rm -rf docs
  - mvn site -B


# Run only after site_documentation. Check if we should release or not
after_deploy:
  - echo $TRAVIS_JOB_NAME
  - if [[ $TRAVIS_JOB_NAME = Release ]]; then ./prepare_release.sh; else terminate_travis 0; fi


# List of jobs to run, tied to specific stages
jobs:
  include:
    - stage: test
      name: test
      install: skip
      script:
        - echo "testing"
    - stage: site_documentation
      name: site_documentation
      install: skip
      script: skip
      deploy:
        provider: pages
        skip_cleanup: true
        github-token: $GREN_GITHUB_TOKEN
        local_dir: docs/
        on:
          branch: test-release-notes
    - stage: release
      name: release
      install: skip
      script: skip          # skip default tests
      before_deploy: skip
      after_deploy: skip    # we don't want to release twice
      deploy:
        provider: releases
        name: $GIT_TAG
        tag_name: $GIT_TAG
        api_key: $GREN_GITHUB_TOKEN
        skip_cleanup: true
        on:
          all_branches: true
          condition: $TRAVIS_BUILD_STAGE_NAME = Release_to_github
